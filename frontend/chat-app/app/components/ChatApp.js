"use strict";
"use client";
Object.defineProperty(exports, "__esModule", { value: true });
const react_1 = require("react");
const ChatMessage_1 = require("./ChatMessage");
const ClearButton_1 = require("./ClearButton");
const SelectMode_1 = require("./SelectMode");
const DebugToggleSwitch_1 = require("./DebugToggleSwitch");
const icons_react_1 = require("@tabler/icons-react");
const auth_1 = require("aws-amplify/auth");
const ChatApp = () => {
    const [messages, setMessages] = (0, react_1.useState)([]);
    const [clean_history, setCleanHistory] = (0, react_1.useState)(false);
    const [debugMode, setDebugMode] = (0, react_1.useState)(false);
    const [assistantMode, setAssistantMode] = (0, react_1.useState)("basic");
    const messageContainerRef = (0, react_1.useRef)(null);
    (0, react_1.useEffect)(() => {
        const storedDebugMode = localStorage.getItem("debugMode");
        setDebugMode(storedDebugMode === "true");
        const storedAssistantMode = localStorage.getItem("assistantMode");
        setAssistantMode(storedAssistantMode === "agentic" ? "agentic" : "basic");
    }, []);
    const handleSendMessage = async (message) => {
        const defaultErrorMessage = "Error while preparing your answer. Check your connectivity to the backend.";
        // fetch the cognito authentication tokens to use with the API call.
        const authToken = (await (0, auth_1.fetchAuthSession)()).tokens?.idToken?.toString();
        const userAttributes = await (0, auth_1.fetchUserAttributes)();
        // Append the user's input message to the message container immediately
        setMessages((prevMessages) => [
            ...prevMessages,
            { content: message, isUser: true },
        ]);
        // Call the API to get the response
        const rest_api_endpoint = process.env.NEXT_PUBLIC_API_ENDPOINT ?? "";
        try {
            const response = await fetch(rest_api_endpoint, {
                // mode: "no-cors",
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: authToken || "",
                },
                // Currently we use the cognito user.sub as a session_id
                // this needs to be updated if one wants to store multiple chats for the same user.
                body: JSON.stringify({
                    user_input: message,
                    session_id: userAttributes.sub,
                    clean_history: clean_history,
                    chatbot_type: assistantMode,
                }),
            });
            const responseData = await response.json();
            // Add the response to the messages state after receiving it
            setCleanHistory(false);
            let AIMessage;
            if (responseData.errorMessage && debugMode) {
                AIMessage = {
                    content: `Error: ${responseData.errorMessage}\n\nDetails: \n\n\`\`\`\n\n${JSON.stringify(responseData, null, 2)}\n\n\`\`\``,
                    isUser: false,
                };
            }
            else if (responseData.errorMessage) {
                AIMessage = { content: defaultErrorMessage, isUser: false };
            }
            else {
                AIMessage = { content: responseData.response, isUser: false };
            }
            setMessages((prevMessages) => [...prevMessages, AIMessage]);
        }
        catch {
            setMessages((prevMessages) => [
                ...prevMessages,
                { content: defaultErrorMessage, isUser: false },
            ]);
        }
    };
    // below useEffect handles automatic scroll down when the messages content
    // overflows the container.
    (0, react_1.useEffect)(() => {
        if (messageContainerRef.current) {
            messageContainerRef.current.scrollTop =
                messageContainerRef.current.scrollHeight;
        }
    }, [messages]);
    return (<div className="bg-white px-4 pb-2 rounded-lg shadow-sm w-full">
      <div className="space-y-4">
        <div ref={messageContainerRef} className="h-[calc(100vh-260px)] px-4 overflow-hidden hover:overflow-y-scroll border-b border-gray-200">
          {messages.map((message, index) => (<ChatMessage_1.default key={index} content={message.content} isUser={message.isUser}/>))}
        </div>
        <div className="flex space-x-2">
          <input id="chat-message-input" className="flex-1 p-2 border rounded-lg border-gray-300 focus:outline-none focus:ring focus:border-blue-500" type="text" placeholder="Type your message..." onKeyDown={(e) => {
            // send message on enter if not empty
            if (e.key === "Enter") {
                if (e.currentTarget.value !== "") {
                    handleSendMessage(e.currentTarget.value);
                    e.currentTarget.value = "";
                }
            }
        }} autoComplete="off"/>
          <button className="px-2 py-2 bg-blue-400 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring focus:ring-2 focus:bg-blue-600 flex items-center" onClick={() => {
            const inputElement = document.getElementById("chat-message-input");
            const message = inputElement.value.trim();
            // send message on button click if not empty
            if (message !== "") {
                handleSendMessage(message);
                inputElement.value = "";
            }
        }}>
            Send
            <icons_react_1.IconSend2 className="h-5 w-5 text-white ml-2"/>
          </button>
        </div>
        <div className="flex justify-between mt-2 items-center w-full">
          <DebugToggleSwitch_1.default onToggle={(value) => setDebugMode(value)}/>
          <SelectMode_1.default onClick={(mode) => {
            setAssistantMode(mode);
        }}/>
          <ClearButton_1.default onClick={() => {
            // Handle clearing the conversation
            setMessages([]);
            setCleanHistory(true);
        }}/>
        </div>
      </div>
    </div>);
};
exports.default = ChatApp;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hhdEFwcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkNoYXRBcHAudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxZQUFZLENBQUM7O0FBRWIsaUNBQTJEO0FBQzNELCtDQUF3QztBQUN4QywrQ0FBd0M7QUFDeEMsNkNBQXNDO0FBQ3RDLDJEQUFvRDtBQUVwRCxxREFBZ0Q7QUFDaEQsMkNBQXlFO0FBT3pFLE1BQU0sT0FBTyxHQUFhLEdBQUcsRUFBRTtJQUM3QixNQUFNLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBWSxFQUFFLENBQUMsQ0FBQztJQUN4RCxNQUFNLENBQUMsYUFBYSxFQUFFLGVBQWUsQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBVSxLQUFLLENBQUMsQ0FBQztJQUNsRSxNQUFNLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBQyxLQUFLLENBQUMsQ0FBQztJQUNsRCxNQUFNLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUNoRCxPQUFPLENBQ1IsQ0FBQztJQUNGLE1BQU0sbUJBQW1CLEdBQUcsSUFBQSxjQUFNLEVBQWlCLElBQUksQ0FBQyxDQUFDO0lBRXpELElBQUEsaUJBQVMsRUFBQyxHQUFHLEVBQUU7UUFDYixNQUFNLGVBQWUsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzFELFlBQVksQ0FBQyxlQUFlLEtBQUssTUFBTSxDQUFDLENBQUM7UUFFekMsTUFBTSxtQkFBbUIsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ2xFLGdCQUFnQixDQUFDLG1CQUFtQixLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM1RSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFUCxNQUFNLGlCQUFpQixHQUFHLEtBQUssRUFBRSxPQUFlLEVBQUUsRUFBRTtRQUNsRCxNQUFNLG1CQUFtQixHQUN2Qiw0RUFBNEUsQ0FBQztRQUMvRSxvRUFBb0U7UUFDcEUsTUFBTSxTQUFTLEdBQUcsQ0FBQyxNQUFNLElBQUEsdUJBQWdCLEdBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLENBQUM7UUFDekUsTUFBTSxjQUFjLEdBQUcsTUFBTSxJQUFBLDBCQUFtQixHQUFFLENBQUM7UUFDbkQsdUVBQXVFO1FBQ3ZFLFdBQVcsQ0FBQyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUM7WUFDNUIsR0FBRyxZQUFZO1lBQ2YsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7U0FDbkMsQ0FBQyxDQUFDO1FBRUgsbUNBQW1DO1FBQ25DLE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsSUFBSSxFQUFFLENBQUM7UUFDckUsSUFBSSxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxLQUFLLENBQUMsaUJBQWlCLEVBQUU7Z0JBQzlDLG1CQUFtQjtnQkFDbkIsTUFBTSxFQUFFLE1BQU07Z0JBQ2QsT0FBTyxFQUFFO29CQUNQLGNBQWMsRUFBRSxrQkFBa0I7b0JBQ2xDLGFBQWEsRUFBRSxTQUFTLElBQUksRUFBRTtpQkFDL0I7Z0JBQ0Qsd0RBQXdEO2dCQUN4RCxtRkFBbUY7Z0JBQ25GLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO29CQUNuQixVQUFVLEVBQUUsT0FBTztvQkFDbkIsVUFBVSxFQUFFLGNBQWMsQ0FBQyxHQUFHO29CQUM5QixhQUFhLEVBQUUsYUFBYTtvQkFDNUIsWUFBWSxFQUFFLGFBQWE7aUJBQzVCLENBQUM7YUFDSCxDQUFDLENBQUM7WUFDSCxNQUFNLFlBQVksR0FBRyxNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUMzQyw0REFBNEQ7WUFDNUQsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZCLElBQUksU0FBa0IsQ0FBQztZQUN2QixJQUFJLFlBQVksQ0FBQyxZQUFZLElBQUksU0FBUyxFQUFFLENBQUM7Z0JBQzNDLFNBQVMsR0FBRztvQkFDVixPQUFPLEVBQUUsVUFDUCxZQUFZLENBQUMsWUFDZiw4QkFBOEIsSUFBSSxDQUFDLFNBQVMsQ0FDMUMsWUFBWSxFQUNaLElBQUksRUFDSixDQUFDLENBQ0YsWUFBWTtvQkFDYixNQUFNLEVBQUUsS0FBSztpQkFDZCxDQUFDO1lBQ0osQ0FBQztpQkFBTSxJQUFJLFlBQVksQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDckMsU0FBUyxHQUFHLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQztZQUM5RCxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sU0FBUyxHQUFHLEVBQUUsT0FBTyxFQUFFLFlBQVksQ0FBQyxRQUFRLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDO1lBQ2hFLENBQUM7WUFDRCxXQUFXLENBQUMsQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxZQUFZLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUM5RCxDQUFDO1FBQUMsTUFBTSxDQUFDO1lBQ1AsV0FBVyxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQztnQkFDNUIsR0FBRyxZQUFZO2dCQUNmLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUU7YUFDaEQsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQztJQUVGLDBFQUEwRTtJQUMxRSwyQkFBMkI7SUFDM0IsSUFBQSxpQkFBUyxFQUFDLEdBQUcsRUFBRTtRQUNiLElBQUksbUJBQW1CLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDaEMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLFNBQVM7Z0JBQ25DLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUM7UUFDN0MsQ0FBQztJQUNILENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFFZixPQUFPLENBQ0wsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLGdEQUFnRCxDQUM3RDtNQUFBLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQ3hCO1FBQUEsQ0FBQyxHQUFHLENBQ0YsR0FBRyxDQUFDLENBQUMsbUJBQW1CLENBQUMsQ0FDekIsU0FBUyxDQUFDLDZGQUE2RixDQUV2RztVQUFBLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQ2hDLENBQUMscUJBQVcsQ0FDVixHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FDWCxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQ3pCLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDdkIsQ0FDSCxDQUFDLENBQ0o7UUFBQSxFQUFFLEdBQUcsQ0FDTDtRQUFBLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FDN0I7VUFBQSxDQUFDLEtBQUssQ0FDSixFQUFFLENBQUMsb0JBQW9CLENBQ3ZCLFNBQVMsQ0FBQyxrR0FBa0csQ0FDNUcsSUFBSSxDQUFDLE1BQU0sQ0FDWCxXQUFXLENBQUMsc0JBQXNCLENBQ2xDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDZixxQ0FBcUM7WUFDckMsSUFBSSxDQUFDLENBQUMsR0FBRyxLQUFLLE9BQU8sRUFBRSxDQUFDO2dCQUN0QixJQUFJLENBQUMsQ0FBQyxhQUFhLENBQUMsS0FBSyxLQUFLLEVBQUUsRUFBRSxDQUFDO29CQUNqQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUN6QyxDQUFDLENBQUMsYUFBYSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7Z0JBQzdCLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQ0YsWUFBWSxDQUFDLEtBQUssRUFFcEI7VUFBQSxDQUFDLE1BQU0sQ0FDTCxTQUFTLENBQUMsOElBQThJLENBQ3hKLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRTtZQUNaLE1BQU0sWUFBWSxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQzFDLG9CQUFvQixDQUNELENBQUM7WUFDdEIsTUFBTSxPQUFPLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUMxQyw0Q0FBNEM7WUFDNUMsSUFBSSxPQUFPLEtBQUssRUFBRSxFQUFFLENBQUM7Z0JBQ25CLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUMzQixZQUFZLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUMxQixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBRUY7O1lBQ0EsQ0FBQyx1QkFBUyxDQUFDLFNBQVMsQ0FBQyx5QkFBeUIsRUFDaEQ7VUFBQSxFQUFFLE1BQU0sQ0FDVjtRQUFBLEVBQUUsR0FBRyxDQUNMO1FBQUEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLCtDQUErQyxDQUM1RDtVQUFBLENBQUMsMkJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUM1RDtVQUFBLENBQUMsb0JBQVUsQ0FDVCxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ2hCLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxFQUVKO1VBQUEsQ0FBQyxxQkFBVyxDQUNWLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRTtZQUNaLG1DQUFtQztZQUNuQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDaEIsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxFQUVOO1FBQUEsRUFBRSxHQUFHLENBQ1A7TUFBQSxFQUFFLEdBQUcsQ0FDUDtJQUFBLEVBQUUsR0FBRyxDQUFDLENBQ1AsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVGLGtCQUFlLE9BQU8sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIGNsaWVudFwiO1xuXG5pbXBvcnQgUmVhY3QsIHsgdXNlU3RhdGUsIHVzZUVmZmVjdCwgdXNlUmVmIH0gZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgQ2hhdE1lc3NhZ2UgZnJvbSBcIi4vQ2hhdE1lc3NhZ2VcIjtcbmltcG9ydCBDbGVhckJ1dHRvbiBmcm9tIFwiLi9DbGVhckJ1dHRvblwiO1xuaW1wb3J0IFNlbGVjdE1vZGUgZnJvbSBcIi4vU2VsZWN0TW9kZVwiO1xuaW1wb3J0IERlYnVnVG9nZ2xlU3dpdGNoIGZyb20gXCIuL0RlYnVnVG9nZ2xlU3dpdGNoXCI7XG5cbmltcG9ydCB7IEljb25TZW5kMiB9IGZyb20gXCJAdGFibGVyL2ljb25zLXJlYWN0XCI7XG5pbXBvcnQgeyBmZXRjaEF1dGhTZXNzaW9uLCBmZXRjaFVzZXJBdHRyaWJ1dGVzIH0gZnJvbSBcImF3cy1hbXBsaWZ5L2F1dGhcIjtcblxuaW50ZXJmYWNlIE1lc3NhZ2Uge1xuICBjb250ZW50OiBzdHJpbmc7XG4gIGlzVXNlcjogYm9vbGVhbjtcbn1cblxuY29uc3QgQ2hhdEFwcDogUmVhY3QuRkMgPSAoKSA9PiB7XG4gIGNvbnN0IFttZXNzYWdlcywgc2V0TWVzc2FnZXNdID0gdXNlU3RhdGU8TWVzc2FnZVtdPihbXSk7XG4gIGNvbnN0IFtjbGVhbl9oaXN0b3J5LCBzZXRDbGVhbkhpc3RvcnldID0gdXNlU3RhdGU8Ym9vbGVhbj4oZmFsc2UpO1xuICBjb25zdCBbZGVidWdNb2RlLCBzZXREZWJ1Z01vZGVdID0gdXNlU3RhdGUoZmFsc2UpO1xuICBjb25zdCBbYXNzaXN0YW50TW9kZSwgc2V0QXNzaXN0YW50TW9kZV0gPSB1c2VTdGF0ZTxcImJhc2ljXCIgfCBcImFnZW50aWNcIj4oXG4gICAgXCJiYXNpY1wiXG4gICk7XG4gIGNvbnN0IG1lc3NhZ2VDb250YWluZXJSZWYgPSB1c2VSZWY8SFRNTERpdkVsZW1lbnQ+KG51bGwpO1xuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgY29uc3Qgc3RvcmVkRGVidWdNb2RlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJkZWJ1Z01vZGVcIik7XG4gICAgc2V0RGVidWdNb2RlKHN0b3JlZERlYnVnTW9kZSA9PT0gXCJ0cnVlXCIpO1xuXG4gICAgY29uc3Qgc3RvcmVkQXNzaXN0YW50TW9kZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFwiYXNzaXN0YW50TW9kZVwiKTtcbiAgICBzZXRBc3Npc3RhbnRNb2RlKHN0b3JlZEFzc2lzdGFudE1vZGUgPT09IFwiYWdlbnRpY1wiID8gXCJhZ2VudGljXCIgOiBcImJhc2ljXCIpO1xuICB9LCBbXSk7XG5cbiAgY29uc3QgaGFuZGxlU2VuZE1lc3NhZ2UgPSBhc3luYyAobWVzc2FnZTogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgZGVmYXVsdEVycm9yTWVzc2FnZSA9XG4gICAgICBcIkVycm9yIHdoaWxlIHByZXBhcmluZyB5b3VyIGFuc3dlci4gQ2hlY2sgeW91ciBjb25uZWN0aXZpdHkgdG8gdGhlIGJhY2tlbmQuXCI7XG4gICAgLy8gZmV0Y2ggdGhlIGNvZ25pdG8gYXV0aGVudGljYXRpb24gdG9rZW5zIHRvIHVzZSB3aXRoIHRoZSBBUEkgY2FsbC5cbiAgICBjb25zdCBhdXRoVG9rZW4gPSAoYXdhaXQgZmV0Y2hBdXRoU2Vzc2lvbigpKS50b2tlbnM/LmlkVG9rZW4/LnRvU3RyaW5nKCk7XG4gICAgY29uc3QgdXNlckF0dHJpYnV0ZXMgPSBhd2FpdCBmZXRjaFVzZXJBdHRyaWJ1dGVzKCk7XG4gICAgLy8gQXBwZW5kIHRoZSB1c2VyJ3MgaW5wdXQgbWVzc2FnZSB0byB0aGUgbWVzc2FnZSBjb250YWluZXIgaW1tZWRpYXRlbHlcbiAgICBzZXRNZXNzYWdlcygocHJldk1lc3NhZ2VzKSA9PiBbXG4gICAgICAuLi5wcmV2TWVzc2FnZXMsXG4gICAgICB7IGNvbnRlbnQ6IG1lc3NhZ2UsIGlzVXNlcjogdHJ1ZSB9LFxuICAgIF0pO1xuXG4gICAgLy8gQ2FsbCB0aGUgQVBJIHRvIGdldCB0aGUgcmVzcG9uc2VcbiAgICBjb25zdCByZXN0X2FwaV9lbmRwb2ludCA9IHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX0FQSV9FTkRQT0lOVCA/PyBcIlwiO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHJlc3RfYXBpX2VuZHBvaW50LCB7XG4gICAgICAgIC8vIG1vZGU6IFwibm8tY29yc1wiLFxuICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgICAgQXV0aG9yaXphdGlvbjogYXV0aFRva2VuIHx8IFwiXCIsXG4gICAgICAgIH0sXG4gICAgICAgIC8vIEN1cnJlbnRseSB3ZSB1c2UgdGhlIGNvZ25pdG8gdXNlci5zdWIgYXMgYSBzZXNzaW9uX2lkXG4gICAgICAgIC8vIHRoaXMgbmVlZHMgdG8gYmUgdXBkYXRlZCBpZiBvbmUgd2FudHMgdG8gc3RvcmUgbXVsdGlwbGUgY2hhdHMgZm9yIHRoZSBzYW1lIHVzZXIuXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICB1c2VyX2lucHV0OiBtZXNzYWdlLFxuICAgICAgICAgIHNlc3Npb25faWQ6IHVzZXJBdHRyaWJ1dGVzLnN1YixcbiAgICAgICAgICBjbGVhbl9oaXN0b3J5OiBjbGVhbl9oaXN0b3J5LFxuICAgICAgICAgIGNoYXRib3RfdHlwZTogYXNzaXN0YW50TW9kZSxcbiAgICAgICAgfSksXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHJlc3BvbnNlRGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgICAgIC8vIEFkZCB0aGUgcmVzcG9uc2UgdG8gdGhlIG1lc3NhZ2VzIHN0YXRlIGFmdGVyIHJlY2VpdmluZyBpdFxuICAgICAgc2V0Q2xlYW5IaXN0b3J5KGZhbHNlKTtcbiAgICAgIGxldCBBSU1lc3NhZ2U6IE1lc3NhZ2U7XG4gICAgICBpZiAocmVzcG9uc2VEYXRhLmVycm9yTWVzc2FnZSAmJiBkZWJ1Z01vZGUpIHtcbiAgICAgICAgQUlNZXNzYWdlID0ge1xuICAgICAgICAgIGNvbnRlbnQ6IGBFcnJvcjogJHtcbiAgICAgICAgICAgIHJlc3BvbnNlRGF0YS5lcnJvck1lc3NhZ2VcbiAgICAgICAgICB9XFxuXFxuRGV0YWlsczogXFxuXFxuXFxgXFxgXFxgXFxuXFxuJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgIHJlc3BvbnNlRGF0YSxcbiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAyXG4gICAgICAgICAgKX1cXG5cXG5cXGBcXGBcXGBgLFxuICAgICAgICAgIGlzVXNlcjogZmFsc2UsXG4gICAgICAgIH07XG4gICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlRGF0YS5lcnJvck1lc3NhZ2UpIHtcbiAgICAgICAgQUlNZXNzYWdlID0geyBjb250ZW50OiBkZWZhdWx0RXJyb3JNZXNzYWdlLCBpc1VzZXI6IGZhbHNlIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBBSU1lc3NhZ2UgPSB7IGNvbnRlbnQ6IHJlc3BvbnNlRGF0YS5yZXNwb25zZSwgaXNVc2VyOiBmYWxzZSB9O1xuICAgICAgfVxuICAgICAgc2V0TWVzc2FnZXMoKHByZXZNZXNzYWdlcykgPT4gWy4uLnByZXZNZXNzYWdlcywgQUlNZXNzYWdlXSk7XG4gICAgfSBjYXRjaCB7XG4gICAgICBzZXRNZXNzYWdlcygocHJldk1lc3NhZ2VzKSA9PiBbXG4gICAgICAgIC4uLnByZXZNZXNzYWdlcyxcbiAgICAgICAgeyBjb250ZW50OiBkZWZhdWx0RXJyb3JNZXNzYWdlLCBpc1VzZXI6IGZhbHNlIH0sXG4gICAgICBdKTtcbiAgICB9XG4gIH07XG5cbiAgLy8gYmVsb3cgdXNlRWZmZWN0IGhhbmRsZXMgYXV0b21hdGljIHNjcm9sbCBkb3duIHdoZW4gdGhlIG1lc3NhZ2VzIGNvbnRlbnRcbiAgLy8gb3ZlcmZsb3dzIHRoZSBjb250YWluZXIuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKG1lc3NhZ2VDb250YWluZXJSZWYuY3VycmVudCkge1xuICAgICAgbWVzc2FnZUNvbnRhaW5lclJlZi5jdXJyZW50LnNjcm9sbFRvcCA9XG4gICAgICAgIG1lc3NhZ2VDb250YWluZXJSZWYuY3VycmVudC5zY3JvbGxIZWlnaHQ7XG4gICAgfVxuICB9LCBbbWVzc2FnZXNdKTtcblxuICByZXR1cm4gKFxuICAgIDxkaXYgY2xhc3NOYW1lPVwiYmctd2hpdGUgcHgtNCBwYi0yIHJvdW5kZWQtbGcgc2hhZG93LXNtIHctZnVsbFwiPlxuICAgICAgPGRpdiBjbGFzc05hbWU9XCJzcGFjZS15LTRcIj5cbiAgICAgICAgPGRpdlxuICAgICAgICAgIHJlZj17bWVzc2FnZUNvbnRhaW5lclJlZn1cbiAgICAgICAgICBjbGFzc05hbWU9XCJoLVtjYWxjKDEwMHZoLTI2MHB4KV0gcHgtNCBvdmVyZmxvdy1oaWRkZW4gaG92ZXI6b3ZlcmZsb3cteS1zY3JvbGwgYm9yZGVyLWIgYm9yZGVyLWdyYXktMjAwXCJcbiAgICAgICAgPlxuICAgICAgICAgIHttZXNzYWdlcy5tYXAoKG1lc3NhZ2UsIGluZGV4KSA9PiAoXG4gICAgICAgICAgICA8Q2hhdE1lc3NhZ2VcbiAgICAgICAgICAgICAga2V5PXtpbmRleH1cbiAgICAgICAgICAgICAgY29udGVudD17bWVzc2FnZS5jb250ZW50fVxuICAgICAgICAgICAgICBpc1VzZXI9e21lc3NhZ2UuaXNVc2VyfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgICApKX1cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZmxleCBzcGFjZS14LTJcIj5cbiAgICAgICAgICA8aW5wdXRcbiAgICAgICAgICAgIGlkPVwiY2hhdC1tZXNzYWdlLWlucHV0XCJcbiAgICAgICAgICAgIGNsYXNzTmFtZT1cImZsZXgtMSBwLTIgYm9yZGVyIHJvdW5kZWQtbGcgYm9yZGVyLWdyYXktMzAwIGZvY3VzOm91dGxpbmUtbm9uZSBmb2N1czpyaW5nIGZvY3VzOmJvcmRlci1ibHVlLTUwMFwiXG4gICAgICAgICAgICB0eXBlPVwidGV4dFwiXG4gICAgICAgICAgICBwbGFjZWhvbGRlcj1cIlR5cGUgeW91ciBtZXNzYWdlLi4uXCJcbiAgICAgICAgICAgIG9uS2V5RG93bj17KGUpID0+IHtcbiAgICAgICAgICAgICAgLy8gc2VuZCBtZXNzYWdlIG9uIGVudGVyIGlmIG5vdCBlbXB0eVxuICAgICAgICAgICAgICBpZiAoZS5rZXkgPT09IFwiRW50ZXJcIikge1xuICAgICAgICAgICAgICAgIGlmIChlLmN1cnJlbnRUYXJnZXQudmFsdWUgIT09IFwiXCIpIHtcbiAgICAgICAgICAgICAgICAgIGhhbmRsZVNlbmRNZXNzYWdlKGUuY3VycmVudFRhcmdldC52YWx1ZSk7XG4gICAgICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQudmFsdWUgPSBcIlwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfX1cbiAgICAgICAgICAgIGF1dG9Db21wbGV0ZT1cIm9mZlwiXG4gICAgICAgICAgLz5cbiAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICBjbGFzc05hbWU9XCJweC0yIHB5LTIgYmctYmx1ZS00MDAgdGV4dC13aGl0ZSByb3VuZGVkLWxnIGhvdmVyOmJnLWJsdWUtNjAwIGZvY3VzOm91dGxpbmUtbm9uZSBmb2N1czpyaW5nIGZvY3VzOnJpbmctMiBmb2N1czpiZy1ibHVlLTYwMCBmbGV4IGl0ZW1zLWNlbnRlclwiXG4gICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGlucHV0RWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxuICAgICAgICAgICAgICAgIFwiY2hhdC1tZXNzYWdlLWlucHV0XCJcbiAgICAgICAgICAgICAgKSBhcyBIVE1MSW5wdXRFbGVtZW50O1xuICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gaW5wdXRFbGVtZW50LnZhbHVlLnRyaW0oKTtcbiAgICAgICAgICAgICAgLy8gc2VuZCBtZXNzYWdlIG9uIGJ1dHRvbiBjbGljayBpZiBub3QgZW1wdHlcbiAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UgIT09IFwiXCIpIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVTZW5kTWVzc2FnZShtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICBpbnB1dEVsZW1lbnQudmFsdWUgPSBcIlwiO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9fVxuICAgICAgICAgID5cbiAgICAgICAgICAgIFNlbmRcbiAgICAgICAgICAgIDxJY29uU2VuZDIgY2xhc3NOYW1lPVwiaC01IHctNSB0ZXh0LXdoaXRlIG1sLTJcIiAvPlxuICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICA8L2Rpdj5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJmbGV4IGp1c3RpZnktYmV0d2VlbiBtdC0yIGl0ZW1zLWNlbnRlciB3LWZ1bGxcIj5cbiAgICAgICAgICA8RGVidWdUb2dnbGVTd2l0Y2ggb25Ub2dnbGU9eyh2YWx1ZSkgPT4gc2V0RGVidWdNb2RlKHZhbHVlKX0gLz5cbiAgICAgICAgICA8U2VsZWN0TW9kZVxuICAgICAgICAgICAgb25DbGljaz17KG1vZGUpID0+IHtcbiAgICAgICAgICAgICAgc2V0QXNzaXN0YW50TW9kZShtb2RlKTtcbiAgICAgICAgICAgIH19XG4gICAgICAgICAgLz5cbiAgICAgICAgICA8Q2xlYXJCdXR0b25cbiAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHtcbiAgICAgICAgICAgICAgLy8gSGFuZGxlIGNsZWFyaW5nIHRoZSBjb252ZXJzYXRpb25cbiAgICAgICAgICAgICAgc2V0TWVzc2FnZXMoW10pO1xuICAgICAgICAgICAgICBzZXRDbGVhbkhpc3RvcnkodHJ1ZSk7XG4gICAgICAgICAgICB9fVxuICAgICAgICAgIC8+XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gICk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBDaGF0QXBwO1xuIl19